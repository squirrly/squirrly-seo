/* 
 * (smt)2 simple mouse tracking v2.1.0
 * Copyleft (cc) 2006-2012 Luis Leiva
 * http://smt2.googlecode.com & http://smt.speedzinemedia.com
 */
(function(){var k={entryPt:"#9F6",exitPt:"#F66",regPt:"#F0F",regLn:"#0CC",click:"#F00",dDrop:"#ABC",varCir:"#F99",cenPt:"#DDD",clust:"#00F",bgColor:"#555",bgLayer:true,realTime:true,dirVect:false,layoutType:"liquid"};var j=window.smt2data;var h=window.jsGraphics;var c=window.smt2fn;if(typeof j==="undefined"){throw ("user data is malformed or not set")}if(typeof h==="undefined"){throw ("jsGraphics library not found")}if(typeof c==="undefined"){throw ("auxiliar (smt) functions not found")}if(typeof JSON.parse!=="function"){throw ("JSON parser not found")}var e;var a=JSON.parse(unescape(j.users));var b=a.length;if(b>1){for(var g=0;g<b;++g){if(a[g].avg){e=a[g];break}}}else{e=a[0]}var f=[];var l=[];var d={i:0,j:1,jMax:0,play:null,jg:null,jgClust:null,jgHelper:null,page:{width:0,height:0},viewport:{width:0,height:0},discrepance:{x:1,y:1},paused:false,createCanvas:function(n){var p=document.createElement("div");p.id=n;p.style.position="absolute";p.style.top=0;p.style.left=0;p.style.width=100+"%";p.style.height=100+"%";p.style.zIndex=c.getNextHighestDepth()+1;var o=document.createElement("div");o.id=n+"Help";o.style.zIndex=p.style.zIndex+1;var m=40;var q=document.createElement("div");q.id=n+"Clust";q.style.position="absolute";q.style.top=0;q.style.left=0;q.style.width=100+"%";q.style.height=100+"%";q.style.opacity=m/100;q.style.filter="alpha(opacity="+m+")";q.style.zIndex=p.style.zIndex+2;var i=document.getElementsByTagName("body")[0];i.appendChild(p);i.appendChild(o);i.appendChild(q);d.jg=new h(p.id);d.jgHelper=new h(o.id);d.jgClust=new h(q.id)},setBgCanvas:function(n){var m=80,p=document.getElementById(n);var o=document.createElement("div");o.id=n+"Bg";o.style.position="absolute";o.style.top=0;o.style.left=0;o.style.width=d.page.width+"px";o.style.height=d.page.height+"px";o.style.overflow="hidden";o.style.backgroundColor=k.bgColor;o.style.opacity=m/100;o.style.filter="alpha(opacity="+m+")";o.style.zIndex=p.style.zIndex-1;var i=document.getElementsByTagName("body")[0];i.appendChild(o)},drawLine:function(m,i){d.jg.setColor(k.regLn);d.jg.drawLine(m.x,m.y,i.x,i.y);d.jg.paint()},drawClick:function(i,o,m){var n;if(!m){n=10;d.jg.setColor(k.click);d.jg.setStroke(5);d.jg.drawLine(i-n,o-n,i,o);d.jg.drawLine(i-n,o+n,i,o);d.jg.drawLine(i+n,o-n,i,o);d.jg.drawLine(i+n,o+n,i,o);d.jg.setStroke(0)}else{n=6;d.jg.setColor(k.dDrop);d.jg.drawRect(i-n/2,o-n/2,n,n)}d.jg.paint()},drawDirectionArrow:function(o,n){var m=o.x-n.x,i=o.y-n.y,p=4;if(m>0&&i>0){d.jg.drawPolyline([n.x-p,n.x,n.x+p],[n.y+p,n.y,n.y+p])}else{if(m<0&&i>0){d.jg.drawPolyline([n.x-p,n.x,n.x-p],[n.y-p,n.y,n.y+p])}else{if(m<0&&i<0){d.jg.drawPolyline([n.x-p,n.x,n.x+p],[n.y-p,n.y,n.y-p])}else{if(m>0&&i<0){d.jg.drawPolyline([n.x+p,n.x,n.x+p],[n.y-p,n.y,n.y+p])}}}}d.jg.paint()},drawCursor:function(i,n,m){d.jg.setColor(m);d.jg.fillPolygon([i,i,i+4,i+6,i+9,i+7,i+15],[n,n+15,n+15,n+23,n+23,n+15,n+15]);d.jg.paint()},drawRegistrationPoint:function(i,m){d.jg.setColor(k.regPt);d.jg.fillRect(i-1,m-1,3,3);d.jg.paint()},drawVariableCircle:function(i,o,n){var m=c.roundTo(n/d.jMax);if(n*m===0){return}if(n>j.wcurr/2){n=Math.round(j.wcurr/2*m)}d.jg.setColor(k.varCir);d.jg.drawEllipse(i-n/2,o-n/2,n,n);d.jg.paint()},drawMouseStop:function(i,o){if(!k.realTime){return}var m=16,n=50;d.jgHelper.setColor(k.varCir);d.jgHelper.fillEllipse(i-n/2,o-n/2,n,n);d.jgHelper.setColor("black");d.jgHelper.setFont("sans-serif",m+"px",Font.BOLD);d.jgHelper.drawString("stopped...",i,o-m/2);d.jgHelper.paint()},drawCentroid:function(){d.jg.setColor(k.cenPt);var p=c.array.sum(f)/f.length;var o=c.array.sum(l)/l.length;if(k.layoutType=="liquid"){p*=d.discrepance.x;p*=d.discrepance.x}else{if(k.layoutType=="center"){p+=d.discrepance.x;p+=d.discrepance.x}}var n=Math.round(p),m=Math.round(o),i=20;d.jg.setStroke(5);d.jg.drawLine(n,m,n+i,m-i);d.jg.drawLine(n,m,n-i,m-i);d.jg.drawLine(n,m,n-i,m+i);d.jg.drawLine(n,m,n+i,m+i);d.jg.setStroke(0);d.jg.paint()},drawClusters:function(n){var m=JSON.parse(n);if(typeof m!=="object"){m=JSON.parse(m)}d.jgClust.setColor(k.clust);for(var p=0,o=0,q=m.sizes.length;p<q;++p){o=m.sizes[p];d.jgClust.fillEllipse(m.xclusters[p]*d.discrepance.x-o/2,m.yclusters[p]*d.discrepance.y-o/2,o,o)}d.jgClust.paint()},distance:function(m,i){return Math.sqrt(Math.pow(m.x-i.x,2)+Math.pow(m.y-i.y,2))},checkAutoScrolling:function(i,m){if(!k.realTime){return}c.doScroll({xpos:i,ypos:m,width:d.viewport.width,height:d.viewport.height})},playMouse:function(){if(d.paused){return}var o={x:e.xcoords[d.i]*d.discrepance.x,y:e.ycoords[d.i]*d.discrepance.y};var n={x:e.xcoords[d.i+1]*d.discrepance.x,y:e.ycoords[d.i+1]*d.discrepance.y};var y=e.clicks[d.i];var i=e.clicks[d.i+1];var x=y>0?e.xcoords[d.i]:0;var r=i>0?e.xcoords[d.i+1]:0;var w=y>0?e.ycoords[d.i]:0;var p=i>0?e.ycoords[d.i+1]:0;var v={x:x*d.discrepance.x,y:w*d.discrepance.y};var u={x:r*d.discrepance.x,y:p*d.discrepance.y};if(d.i===0){d.drawCursor(o.x,o.y,k.entryPt)}if(d.i<e.xcoords.length){var q=d.distance(o,n);if(q){if(!k.dirVect){d.drawRegistrationPoint(o.x,o.y)}else{d.drawDirectionArrow(o,n)}if(d.j>1){d.drawVariableCircle(o.x,o.y,d.j);d.jgHelper.clear()}d.j=1}else{++d.j;d.drawMouseStop(o.x,o.y)}d.drawLine(o,n);if(v.x){var t=d.distance(v,u);if(!t){d.drawClick(u.x,u.y,false)}else{if(u.x!==0){d.drawClick(v.x,v.y,true)}}}++d.i;d.checkAutoScrolling(n.x,n.y)}else{--d.i;o.x=e.xcoords[d.i]*d.discrepance.x;o.y=e.ycoords[d.i]*d.discrepance.y;d.drawCursor(o.x,o.y,k.exitPt);var m="xhr=1";m+="&xdata="+JSON.stringify(e.xcoords);m+="&ydata="+JSON.stringify(e.ycoords);var s=c.getBaseURL();c.sendAjaxRequest({url:s+"includes/kmeans.php",postdata:m,callback:d.drawClusters});d.drawCentroid();clearInterval(d.play);d.play=null;d.jgHelper.clear();if(b==1){c.loadNextMouseTrail(j)}}},replay:function(i){if(i){var n=Math.round(1000/j.fps);d.play=setInterval(d.playMouse,n)}else{for(var m=0,o=e.xcoords.length;m<=o;++m){d.playMouse()}}},reset:function(){clearInterval(d.play);d.paused=false;d.i=0;d.j=1;d.jg.clear();d.jgClust.clear()},helpKeys:function(o){if(!k.realTime){return}if(!o){o=window.event}var n=o.keyCode||o.which;if(n==27){clearInterval(d.play);d.paused=false;k.realTime=false;for(var i=d.i,m=e.xcoords.length;i<=m;++i){d.playMouse()}}else{if(n==32){d.paused=!d.paused}}},init:function(){var o=c.getWindowSize();d.viewport.width=o.width;d.viewport.height=o.height;var r=c.getPageSize();d.page.width=r.width;d.page.height=r.height;if(e.wprev&&e.hprev){d.discrepance.x=c.roundTo(r.width/e.wprev);d.discrepance.y=c.roundTo(r.height/e.hprev)}var q=[];var p=1;for(var n=0,i=e.xcoords.length;n<i;++n){if(e.xcoords[n]==e.xcoords[n+1]&&e.ycoords[n]==e.ycoords[n+1]){++p}else{if(p>1){q.push(p)}p=1;f.push(e.xcoords[n]);l.push(e.ycoords[n])}}d.jMax=c.array.max(q);var m="smtCanvas";d.createCanvas(m);if(k.bgLayer){d.setBgCanvas(m)}d.replay(k.realTime)}};if(typeof window.smt2!=="undefined"){throw ("smt2 namespace conflict")}window.smt2={replay:function(i){if(typeof i!=="undefined"){c.overrideTrackingOptions(k,i)}c.addEvent(document,"keyup",d.helpKeys);c.onDOMload(function(){c.allowTrackingOnFlashObjects(document)});c.addEvent(window,"load",d.init)}}})();